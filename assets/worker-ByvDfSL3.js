var ke=Object.defineProperty;var pe=(R,C,m)=>C in R?ke(R,C,{enumerable:!0,configurable:!0,writable:!0,value:m}):R[C]=m;var f=(R,C,m)=>pe(R,typeof C!="symbol"?C+"":C,m);(function(){"use strict";const R=["a","b","c","d","e","f","g","h"],C=["1","2","3","4","5","6","7","8"],m=["white","black"],b=["pawn","knight","bishop","rook","queen","king"],Tt=["a","h"],$=e=>"role"in e,c=e=>e!==void 0,w=e=>e==="white"?"black":"white",D=e=>e>>3,O=e=>e&7,W=(e,t)=>0<=e&&e<8&&0<=t&&t<8?e+8*t:void 0,lt=e=>{switch(e){case"pawn":return"p";case"knight":return"n";case"bishop":return"b";case"rook":return"r";case"queen":return"q";case"king":return"k"}};function Y(e){switch(e.toLowerCase()){case"p":return"pawn";case"n":return"knight";case"b":return"bishop";case"r":return"rook";case"q":return"queen";case"k":return"king";default:return}}function U(e){if(e.length===2)return W(e.charCodeAt(0)-97,e.charCodeAt(1)-49)}const Mt=e=>R[O(e)]+C[D(e)],Nt=e=>{if(e[1]==="@"&&e.length===4){const t=Y(e[0]),s=U(e.slice(2));if(t&&c(s))return{role:t,to:s}}else if(e.length===4||e.length===5){const t=U(e.slice(0,2)),s=U(e.slice(2,4));let i;if(e.length===5&&(i=Y(e[4]),!i))return;if(c(t)&&c(s))return{from:t,to:s,promotion:i}}},J=(e,t)=>e==="white"?t==="a"?2:6:t==="a"?58:62,X=(e,t)=>e==="white"?t==="a"?3:5:t==="a"?59:61,ft=e=>(e=e-(e>>>1&1431655765),e=(e&858993459)+(e>>>2&858993459),Math.imul(e+(e>>>4)&252645135,16843009)>>24),Z=e=>(e=e>>>8&16711935|(e&16711935)<<8,e>>>16&65535|(e&65535)<<16),ut=e=>(e=e>>>1&1431655765|(e&1431655765)<<1,e=e>>>2&858993459|(e&858993459)<<2,e=e>>>4&252645135|(e&252645135)<<4,Z(e));class r{constructor(t,s){f(this,"lo");f(this,"hi");this.lo=t|0,this.hi=s|0}static fromSquare(t){return t>=32?new r(0,1<<t-32):new r(1<<t,0)}static fromRank(t){return new r(255,0).shl64(8*t)}static fromFile(t){return new r(16843009<<t,16843009<<t)}static empty(){return new r(0,0)}static full(){return new r(4294967295,4294967295)}static corners(){return new r(129,2164260864)}static center(){return new r(402653184,24)}static backranks(){return new r(255,4278190080)}static backrank(t){return t==="white"?new r(255,0):new r(0,4278190080)}static lightSquares(){return new r(1437226410,1437226410)}static darkSquares(){return new r(2857740885,2857740885)}complement(){return new r(~this.lo,~this.hi)}xor(t){return new r(this.lo^t.lo,this.hi^t.hi)}union(t){return new r(this.lo|t.lo,this.hi|t.hi)}intersect(t){return new r(this.lo&t.lo,this.hi&t.hi)}diff(t){return new r(this.lo&~t.lo,this.hi&~t.hi)}intersects(t){return this.intersect(t).nonEmpty()}isDisjoint(t){return this.intersect(t).isEmpty()}supersetOf(t){return t.diff(this).isEmpty()}subsetOf(t){return this.diff(t).isEmpty()}shr64(t){return t>=64?r.empty():t>=32?new r(this.hi>>>t-32,0):t>0?new r(this.lo>>>t^this.hi<<32-t,this.hi>>>t):this}shl64(t){return t>=64?r.empty():t>=32?new r(0,this.lo<<t-32):t>0?new r(this.lo<<t,this.hi<<t^this.lo>>>32-t):this}bswap64(){return new r(Z(this.hi),Z(this.lo))}rbit64(){return new r(ut(this.hi),ut(this.lo))}minus64(t){const s=this.lo-t.lo,i=(s&t.lo&1)+(t.lo>>>1)+(s>>>1)>>>31;return new r(s,this.hi-(t.hi+i))}equals(t){return this.lo===t.lo&&this.hi===t.hi}size(){return ft(this.lo)+ft(this.hi)}isEmpty(){return this.lo===0&&this.hi===0}nonEmpty(){return this.lo!==0||this.hi!==0}has(t){return(t>=32?this.hi&1<<t-32:this.lo&1<<t)!==0}set(t,s){return s?this.with(t):this.without(t)}with(t){return t>=32?new r(this.lo,this.hi|1<<t-32):new r(this.lo|1<<t,this.hi)}without(t){return t>=32?new r(this.lo,this.hi&~(1<<t-32)):new r(this.lo&~(1<<t),this.hi)}toggle(t){return t>=32?new r(this.lo,this.hi^1<<t-32):new r(this.lo^1<<t,this.hi)}last(){if(this.hi!==0)return 63-Math.clz32(this.hi);if(this.lo!==0)return 31-Math.clz32(this.lo)}first(){if(this.lo!==0)return 31-Math.clz32(this.lo&-this.lo);if(this.hi!==0)return 63-Math.clz32(this.hi&-this.hi)}withoutFirst(){return this.lo!==0?new r(this.lo&this.lo-1,this.hi):new r(0,this.hi&this.hi-1)}moreThanOne(){return this.hi!==0&&this.lo!==0||(this.lo&this.lo-1)!==0||(this.hi&this.hi-1)!==0}singleSquare(){return this.moreThanOne()?void 0:this.last()}*[Symbol.iterator](){let t=this.lo,s=this.hi;for(;t!==0;){const i=31-Math.clz32(t&-t);t^=1<<i,yield i}for(;s!==0;){const i=31-Math.clz32(s&-s);s^=1<<i,yield 32+i}}*reversed(){let t=this.lo,s=this.hi;for(;s!==0;){const i=31-Math.clz32(s);s^=1<<i,yield 32+i}for(;t!==0;){const i=31-Math.clz32(t);t^=1<<i,yield i}}}function vt(e){if(e%8!==0)return e-1}function Lt(e){if((e+1)%8!==0)return e+1}function q(e){if(e+8<64)return e+8}function tt(e){if(e-8>=0)return e-8}function Kt(e){let t=vt(e),s=Lt(e),i=q(e),n=tt(e);return[t!==void 0?q(t):void 0,i,s!==void 0?q(s):void 0,t,e,s,t!==void 0?tt(t):void 0,n,s!==void 0?tt(s):void 0]}const Q=(e,t)=>{let s=r.empty();for(const i of t){const n=e+i;0<=n&&n<64&&Math.abs(O(e)-O(n))<=2&&(s=s.with(n))}return s},_=e=>{const t=[];for(let s=0;s<64;s++)t[s]=e(s);return t},Ft=_(e=>Q(e,[-9,-8,-7,-1,1,7,8,9])),Dt=_(e=>Q(e,[-17,-15,-10,-6,6,10,15,17])),It={white:_(e=>Q(e,[7,9])),black:_(e=>Q(e,[-7,-9]))},dt=e=>Ft[e],kt=e=>Dt[e],S=(e,t)=>It[e][t],et=_(e=>r.fromFile(O(e)).without(e)),st=_(e=>r.fromRank(D(e)).without(e)),it=_(e=>{const t=new r(134480385,2151686160),s=8*(D(e)-O(e));return(s>=0?t.shl64(s):t.shr64(-s)).without(e)}),nt=_(e=>{const t=new r(270549120,16909320),s=8*(D(e)+O(e)-7);return(s>=0?t.shl64(s):t.shr64(-s)).without(e)}),rt=(e,t,s)=>{let i=s.intersect(t),n=i.bswap64();return i=i.minus64(e),n=n.minus64(e.bswap64()),i.xor(n.bswap64()).intersect(t)},Bt=(e,t)=>rt(r.fromSquare(e),et[e],t),Gt=(e,t)=>{const s=st[e];let i=t.intersect(s),n=i.rbit64();return i=i.minus64(r.fromSquare(e)),n=n.minus64(r.fromSquare(63-e)),i.xor(n.rbit64()).intersect(s)},z=(e,t)=>{const s=r.fromSquare(e);return rt(s,it[e],t).xor(rt(s,nt[e],t))},V=(e,t)=>Bt(e,t).xor(Gt(e,t)),Ut=(e,t)=>z(e,t).xor(V(e,t)),pt=(e,t)=>{const s=r.fromSquare(t);return st[e].intersects(s)?st[e].with(e):nt[e].intersects(s)?nt[e].with(e):it[e].intersects(s)?it[e].with(e):et[e].intersects(s)?et[e].with(e):r.empty()},I=(e,t)=>pt(e,t).intersect(r.full().shl64(e).xor(r.full().shl64(t))).withoutFirst();class N{constructor(){f(this,"occupied");f(this,"promoted");f(this,"white");f(this,"black");f(this,"pawn");f(this,"knight");f(this,"bishop");f(this,"rook");f(this,"queen");f(this,"king")}static default(){const t=new N;return t.reset(),t}reset(){this.occupied=new r(65535,4294901760),this.promoted=r.empty(),this.white=new r(65535,0),this.black=new r(0,4294901760),this.pawn=new r(65280,16711680),this.knight=new r(66,1107296256),this.bishop=new r(36,603979776),this.rook=new r(129,2164260864),this.queen=new r(8,134217728),this.king=new r(16,268435456)}static empty(){const t=new N;return t.clear(),t}clear(){this.occupied=r.empty(),this.promoted=r.empty();for(const t of m)this[t]=r.empty();for(const t of b)this[t]=r.empty()}clone(){const t=new N;t.occupied=this.occupied,t.promoted=this.promoted;for(const s of m)t[s]=this[s];for(const s of b)t[s]=this[s];return t}getColor(t){if(this.white.has(t))return"white";if(this.black.has(t))return"black"}getRole(t){for(const s of b)if(this[s].has(t))return s}get(t){const s=this.getColor(t);if(!s)return;const i=this.getRole(t),n=this.promoted.has(t);return{color:s,role:i,promoted:n}}take(t){const s=this.get(t);return s&&(this.occupied=this.occupied.without(t),this[s.color]=this[s.color].without(t),this[s.role]=this[s.role].without(t),s.promoted&&(this.promoted=this.promoted.without(t))),s}set(t,s){const i=this.take(t);return this.occupied=this.occupied.with(t),this[s.color]=this[s.color].with(t),this[s.role]=this[s.role].with(t),s.promoted&&(this.promoted=this.promoted.with(t)),i}has(t){return this.occupied.has(t)}*[Symbol.iterator](){for(const t of this.occupied)yield[t,this.get(t)]}pieces(t,s){return this[t].intersect(this[s])}rooksAndQueens(){return this.rook.union(this.queen)}bishopsAndQueens(){return this.bishop.union(this.queen)}kingOf(t){return this.pieces(t,"king").singleSquare()}}class E{constructor(){f(this,"pawn");f(this,"knight");f(this,"bishop");f(this,"rook");f(this,"queen");f(this,"king")}static empty(){const t=new E;for(const s of b)t[s]=0;return t}static fromBoard(t,s){const i=new E;for(const n of b)i[n]=t.pieces(s,n).size();return i}clone(){const t=new E;for(const s of b)t[s]=this[s];return t}equals(t){return b.every(s=>this[s]===t[s])}add(t){const s=new E;for(const i of b)s[i]=this[i]+t[i];return s}subtract(t){const s=new E;for(const i of b)s[i]=this[i]-t[i];return s}nonEmpty(){return b.some(t=>this[t]>0)}isEmpty(){return!this.nonEmpty()}hasPawns(){return this.pawn>0}hasNonPawns(){return this.knight>0||this.bishop>0||this.rook>0||this.queen>0||this.king>0}size(){return this.pawn+this.knight+this.bishop+this.rook+this.queen+this.king}}class P{constructor(t,s){f(this,"white");f(this,"black");this.white=t,this.black=s}static empty(){return new P(E.empty(),E.empty())}static fromBoard(t){return new P(E.fromBoard(t,"white"),E.fromBoard(t,"black"))}clone(){return new P(this.white.clone(),this.black.clone())}equals(t){return this.white.equals(t.white)&&this.black.equals(t.black)}add(t){return new P(this.white.add(t.white),this.black.add(t.black))}subtract(t){return new P(this.white.subtract(t.white),this.black.subtract(t.black))}count(t){return this.white[t]+this.black[t]}size(){return this.white.size()+this.black.size()}isEmpty(){return this.white.isEmpty()&&this.black.isEmpty()}nonEmpty(){return!this.isEmpty()}hasPawns(){return this.white.hasPawns()||this.black.hasPawns()}hasNonPawns(){return this.white.hasNonPawns()||this.black.hasNonPawns()}}class B{constructor(t,s){f(this,"white");f(this,"black");this.white=t,this.black=s}static default(){return new B(3,3)}clone(){return new B(this.white,this.black)}equals(t){return this.white===t.white&&this.black===t.black}}class wt{unwrap(t,s){const i=this._chain(n=>l.ok(t?t(n):n),n=>s?l.ok(s(n)):l.err(n));if(i.isErr)throw i.error;return i.value}map(t,s){return this._chain(i=>l.ok(t(i)),i=>l.err(s?s(i):i))}chain(t,s){return this._chain(t,s||(i=>l.err(i)))}}class Qt extends wt{constructor(t){super(),this.value=void 0,this.isOk=!0,this.isErr=!1,this.value=t}_chain(t,s){return t(this.value)}}class St extends wt{constructor(t){super(),this.error=void 0,this.isOk=!1,this.isErr=!0,this.error=t}_chain(t,s){return s(this.error)}}var l;(function(e){e.ok=function(t){return new Qt(t)},e.err=function(t){return new St(t||new Error)},e.all=function(t){if(Array.isArray(t)){const n=[];for(let o=0;o<t.length;o++){const h=t[o];if(h.isErr)return h;n.push(h.value)}return e.ok(n)}const s={},i=Object.keys(t);for(let n=0;n<i.length;n++){const o=t[i[n]];if(o.isErr)return o;s[i[n]]=o.value}return e.ok(s)}})(l||(l={}));var A;(function(e){e.Empty="ERR_EMPTY",e.OppositeCheck="ERR_OPPOSITE_CHECK",e.PawnsOnBackrank="ERR_PAWNS_ON_BACKRANK",e.Kings="ERR_KINGS",e.Variant="ERR_VARIANT"})(A||(A={}));class v extends Error{}const zt=(e,t,s,i)=>s[t].intersect(V(e,i).intersect(s.rooksAndQueens()).union(z(e,i).intersect(s.bishopsAndQueens())).union(kt(e).intersect(s.knight)).union(dt(e).intersect(s.king)).union(S(w(t),e).intersect(s.pawn)));class T{constructor(){f(this,"castlingRights");f(this,"rook");f(this,"path")}static default(){const t=new T;return t.castlingRights=r.corners(),t.rook={white:{a:0,h:7},black:{a:56,h:63}},t.path={white:{a:new r(14,0),h:new r(96,0)},black:{a:new r(0,234881024),h:new r(0,1610612736)}},t}static empty(){const t=new T;return t.castlingRights=r.empty(),t.rook={white:{a:void 0,h:void 0},black:{a:void 0,h:void 0}},t.path={white:{a:r.empty(),h:r.empty()},black:{a:r.empty(),h:r.empty()}},t}clone(){const t=new T;return t.castlingRights=this.castlingRights,t.rook={white:{a:this.rook.white.a,h:this.rook.white.h},black:{a:this.rook.black.a,h:this.rook.black.h}},t.path={white:{a:this.path.white.a,h:this.path.white.h},black:{a:this.path.black.a,h:this.path.black.h}},t}add(t,s,i,n){const o=J(t,s),h=X(t,s);this.castlingRights=this.castlingRights.with(n),this.rook[t][s]=n,this.path[t][s]=I(n,h).with(h).union(I(i,o).with(o)).without(i).without(n)}static fromSetup(t){const s=T.empty(),i=t.castlingRights.intersect(t.board.rook);for(const n of m){const o=r.backrank(n),h=t.board.kingOf(n);if(!c(h)||!o.has(h))continue;const a=i.intersect(t.board[n]).intersect(o),u=a.first();c(u)&&u<h&&s.add(n,"a",h,u);const d=a.last();c(d)&&h<d&&s.add(n,"h",h,d)}return s}discardRook(t){if(this.castlingRights.has(t)){this.castlingRights=this.castlingRights.without(t);for(const s of m)for(const i of Tt)this.rook[s][i]===t&&(this.rook[s][i]=void 0)}}discardColor(t){this.castlingRights=this.castlingRights.diff(r.backrank(t)),this.rook[t].a=void 0,this.rook[t].h=void 0}}class Vt{constructor(t){f(this,"rules");f(this,"board");f(this,"pockets");f(this,"turn");f(this,"castles");f(this,"epSquare");f(this,"remainingChecks");f(this,"halfmoves");f(this,"fullmoves");this.rules=t}reset(){this.board=N.default(),this.pockets=void 0,this.turn="white",this.castles=T.default(),this.epSquare=void 0,this.remainingChecks=void 0,this.halfmoves=0,this.fullmoves=1}setupUnchecked(t){this.board=t.board.clone(),this.board.promoted=r.empty(),this.pockets=void 0,this.turn=t.turn,this.castles=T.fromSetup(t),this.epSquare=Ht(this,t.epSquare),this.remainingChecks=void 0,this.halfmoves=t.halfmoves,this.fullmoves=t.fullmoves}kingAttackers(t,s,i){return zt(t,s,this.board,i)}playCaptureAt(t,s){this.halfmoves=0,s.role==="rook"&&this.castles.discardRook(t),this.pockets&&this.pockets[w(s.color)][s.promoted?"pawn":s.role]++}ctx(){const t=this.isVariantEnd(),s=this.board.kingOf(this.turn);if(!c(s))return{king:s,blockers:r.empty(),checkers:r.empty(),variantEnd:t,mustCapture:!1};const i=V(s,r.empty()).intersect(this.board.rooksAndQueens()).union(z(s,r.empty()).intersect(this.board.bishopsAndQueens())).intersect(this.board[w(this.turn)]);let n=r.empty();for(const h of i){const a=I(s,h).intersect(this.board.occupied);a.moreThanOne()||(n=n.union(a))}const o=this.kingAttackers(s,w(this.turn),this.board.occupied);return{king:s,blockers:n,checkers:o,variantEnd:t,mustCapture:!1}}clone(){var s,i;const t=new this.constructor;return t.board=this.board.clone(),t.pockets=(s=this.pockets)==null?void 0:s.clone(),t.turn=this.turn,t.castles=this.castles.clone(),t.epSquare=this.epSquare,t.remainingChecks=(i=this.remainingChecks)==null?void 0:i.clone(),t.halfmoves=this.halfmoves,t.fullmoves=this.fullmoves,t}validate(){if(this.board.occupied.isEmpty())return l.err(new v(A.Empty));if(this.board.king.size()!==2)return l.err(new v(A.Kings));if(!c(this.board.kingOf(this.turn)))return l.err(new v(A.Kings));const t=this.board.kingOf(w(this.turn));return c(t)?this.kingAttackers(t,this.turn,this.board.occupied).nonEmpty()?l.err(new v(A.OppositeCheck)):r.backranks().intersects(this.board.pawn)?l.err(new v(A.PawnsOnBackrank)):l.ok(void 0):l.err(new v(A.Kings))}dropDests(t){return r.empty()}dests(t,s){if(s=s||this.ctx(),s.variantEnd)return r.empty();const i=this.board.get(t);if(!i||i.color!==this.turn)return r.empty();let n,o;if(i.role==="pawn"){n=S(this.turn,t).intersect(this.board[w(this.turn)]);const h=this.turn==="white"?8:-8,a=t+h;if(0<=a&&a<64&&!this.board.occupied.has(a)){n=n.with(a);const u=this.turn==="white"?t<16:t>=48,d=a+h;u&&!this.board.occupied.has(d)&&(n=n.with(d))}c(this.epSquare)&&$t(this,t,s)&&(o=r.fromSquare(this.epSquare))}else i.role==="bishop"?n=z(t,this.board.occupied):i.role==="knight"?n=kt(t):i.role==="rook"?n=V(t,this.board.occupied):i.role==="queen"?n=Ut(t,this.board.occupied):n=dt(t);if(n=n.diff(this.board[this.turn]),c(s.king)){if(i.role==="king"){const h=this.board.occupied.without(t);for(const a of n)this.kingAttackers(a,w(this.turn),h).nonEmpty()&&(n=n.without(a));return n.union(mt(this,"a",s)).union(mt(this,"h",s))}if(s.checkers.nonEmpty()){const h=s.checkers.singleSquare();if(!c(h))return r.empty();n=n.intersect(I(h,s.king).with(h))}s.blockers.has(t)&&(n=n.intersect(pt(t,s.king)))}return o&&(n=n.union(o)),n}isVariantEnd(){return!1}variantOutcome(t){}hasInsufficientMaterial(t){return this.board[t].intersect(this.board.pawn.union(this.board.rooksAndQueens())).nonEmpty()?!1:this.board[t].intersects(this.board.knight)?this.board[t].size()<=2&&this.board[w(t)].diff(this.board.king).diff(this.board.queen).isEmpty():this.board[t].intersects(this.board.bishop)?(!this.board.bishop.intersects(r.darkSquares())||!this.board.bishop.intersects(r.lightSquares()))&&this.board.pawn.isEmpty()&&this.board.knight.isEmpty():!0}toSetup(){var t,s;return{board:this.board.clone(),pockets:(t=this.pockets)==null?void 0:t.clone(),turn:this.turn,castlingRights:this.castles.castlingRights,epSquare:jt(this),remainingChecks:(s=this.remainingChecks)==null?void 0:s.clone(),halfmoves:Math.min(this.halfmoves,150),fullmoves:Math.min(Math.max(this.fullmoves,1),9999)}}isInsufficientMaterial(){return m.every(t=>this.hasInsufficientMaterial(t))}hasDests(t){t=t||this.ctx();for(const s of this.board[this.turn])if(this.dests(s,t).nonEmpty())return!0;return this.dropDests(t).nonEmpty()}isLegal(t,s){if($(t))return!this.pockets||this.pockets[this.turn][t.role]<=0||t.role==="pawn"&&r.backranks().has(t.to)?!1:this.dropDests(s).has(t.to);{if(t.promotion==="pawn"||t.promotion==="king"&&this.rules!=="antichess"||!!t.promotion!==(this.board.pawn.has(t.from)&&r.backranks().has(t.to)))return!1;const i=this.dests(t.from,s);return i.has(t.to)||i.has(Wt(this,t).to)}}isCheck(){const t=this.board.kingOf(this.turn);return c(t)&&this.kingAttackers(t,w(this.turn),this.board.occupied).nonEmpty()}isEnd(t){return(t?t.variantEnd:this.isVariantEnd())?!0:this.isInsufficientMaterial()||!this.hasDests(t)}isCheckmate(t){return t=t||this.ctx(),!t.variantEnd&&t.checkers.nonEmpty()&&!this.hasDests(t)}isStalemate(t){return t=t||this.ctx(),!t.variantEnd&&t.checkers.isEmpty()&&!this.hasDests(t)}outcome(t){const s=this.variantOutcome(t);return s||(t=t||this.ctx(),this.isCheckmate(t)?{winner:w(this.turn)}:this.isInsufficientMaterial()||this.isStalemate(t)?{winner:void 0}:void 0)}allDests(t){t=t||this.ctx();const s=new Map;if(t.variantEnd)return s;for(const i of this.board[this.turn])s.set(i,this.dests(i,t));return s}play(t){const s=this.turn,i=this.epSquare,n=bt(this,t);if(this.epSquare=void 0,this.halfmoves+=1,s==="black"&&(this.fullmoves+=1),this.turn=w(s),$(t))this.board.set(t.to,{role:t.role,color:s}),this.pockets&&this.pockets[s][t.role]--,t.role==="pawn"&&(this.halfmoves=0);else{const o=this.board.take(t.from);if(!o)return;let h;if(o.role==="pawn"){this.halfmoves=0,t.to===i&&(h=this.board.take(t.to+(s==="white"?-8:8)));const a=t.from-t.to;Math.abs(a)===16&&8<=t.from&&t.from<=55&&(this.epSquare=t.from+t.to>>1),t.promotion&&(o.role=t.promotion,o.promoted=!!this.pockets)}else if(o.role==="rook")this.castles.discardRook(t.from);else if(o.role==="king"){if(n){const a=this.castles.rook[s][n];if(c(a)){const u=this.board.take(a);this.board.set(J(s,n),o),u&&this.board.set(X(s,n),u)}}this.castles.discardColor(s)}if(!n){const a=this.board.set(t.to,o)||h;a&&this.playCaptureAt(t.to,a)}}this.remainingChecks&&this.isCheck()&&(this.remainingChecks[s]=Math.max(this.remainingChecks[s]-1,0))}}class gt extends Vt{constructor(){super("chess")}static default(){const t=new this;return t.reset(),t}static fromSetup(t){const s=new this;return s.setupUnchecked(t),s.validate().map(i=>s)}clone(){return super.clone()}}const Ht=(e,t)=>{if(!c(t))return;const s=e.turn==="white"?5:2,i=e.turn==="white"?8:-8;if(D(t)!==s||e.board.occupied.has(t+i))return;const n=t-i;if(!(!e.board.pawn.has(n)||!e.board[w(e.turn)].has(n)))return t},jt=e=>{if(!c(e.epSquare))return;const t=e.ctx(),i=e.board.pieces(e.turn,"pawn").intersect(S(w(e.turn),e.epSquare));for(const n of i)if(e.dests(n,t).has(e.epSquare))return e.epSquare},$t=(e,t,s)=>{if(!c(e.epSquare)||!S(e.turn,t).has(e.epSquare))return!1;if(!c(s.king))return!0;const i=e.turn==="white"?8:-8,n=e.epSquare-i;return e.kingAttackers(s.king,w(e.turn),e.board.occupied.toggle(t).toggle(n).with(e.epSquare)).without(n).isEmpty()},mt=(e,t,s)=>{if(!c(s.king)||s.checkers.nonEmpty())return r.empty();const i=e.castles.rook[e.turn][t];if(!c(i)||e.castles.path[e.turn][t].intersects(e.board.occupied))return r.empty();const n=J(e.turn,t),o=I(s.king,n),h=e.board.occupied.without(s.king);for(const d of o)if(e.kingAttackers(d,w(e.turn),h).nonEmpty())return r.empty();const a=X(e.turn,t),u=e.board.occupied.toggle(s.king).toggle(i).toggle(a);return e.kingAttackers(n,w(e.turn),u).nonEmpty()?r.empty():r.fromSquare(i)},bt=(e,t)=>{if($(t))return;const s=t.to-t.from;if(!(Math.abs(s)!==2&&!e.board[e.turn].has(t.to))&&e.board.king.has(t.from))return s>0?"h":"a"},Wt=(e,t)=>{const s=bt(e,t);if(!s)return t;const i=e.castles.rook[e.turn][s];return{from:t.from,to:c(i)?i:t.to}};var k;(function(e){e.Fen="ERR_FEN",e.Board="ERR_BOARD",e.Pockets="ERR_POCKETS",e.Turn="ERR_TURN",e.Castling="ERR_CASTLING",e.EpSquare="ERR_EP_SQUARE",e.RemainingChecks="ERR_REMAINING_CHECKS",e.Halfmoves="ERR_HALFMOVES",e.Fullmoves="ERR_FULLMOVES"})(k||(k={}));class g extends Error{}const Yt=(e,t,s)=>{let i=e.indexOf(t);for(;s-- >0&&i!==-1;)i=e.indexOf(t,i+t.length);return i},L=e=>/^\d{1,4}$/.test(e)?parseInt(e,10):void 0,yt=e=>{const t=Y(e);return t&&{role:t,color:e.toLowerCase()===e?"black":"white"}},ot=e=>{const t=N.empty();let s=7,i=0;for(let n=0;n<e.length;n++){const o=e[n];if(o==="/"&&i===8)i=0,s--;else{const h=parseInt(o,10);if(h>0)i+=h;else{if(i>=8||s<0)return l.err(new g(k.Board));const a=i+s*8,u=yt(o);if(!u)return l.err(new g(k.Board));e[n+1]==="~"&&(u.promoted=!0,n++),t.set(a,u),i++}}}return s!==0||i!==8?l.err(new g(k.Board)):l.ok(t)},Et=e=>{if(e.length>64)return l.err(new g(k.Pockets));const t=P.empty();for(const s of e){const i=yt(s);if(!i)return l.err(new g(k.Pockets));t[i.color][i.role]++}return l.ok(t)},Jt=(e,t)=>{let s=r.empty();if(t==="-")return l.ok(s);for(const i of t){const n=i.toLowerCase(),o=i===n?"black":"white",h=o==="white"?0:7;if("a"<=n&&n<="h")s=s.with(W(n.charCodeAt(0)-97,h));else if(n==="k"||n==="q"){const a=e[o].intersect(r.backrank(o)).intersect(e.rook.union(e.king)),u=n==="k"?a.last():a.first();s=s.with(c(u)&&e.rook.has(u)?u:W(n==="k"?7:0,h))}else return l.err(new g(k.Castling))}return m.some(i=>r.backrank(i).intersect(s).size()>2)?l.err(new g(k.Castling)):l.ok(s)},Ct=e=>{const t=e.split("+");if(t.length===3&&t[0]===""){const s=L(t[1]),i=L(t[2]);return!c(s)||s>3||!c(i)||i>3?l.err(new g(k.RemainingChecks)):l.ok(new B(3-s,3-i))}else if(t.length===2){const s=L(t[0]),i=L(t[1]);return!c(s)||s>3||!c(i)||i>3?l.err(new g(k.RemainingChecks)):l.ok(new B(s,i))}else return l.err(new g(k.RemainingChecks))},Rt=e=>{const t=e.split(/[\s_]+/),s=t.shift();let i,n=l.ok(void 0);if(s.endsWith("]")){const a=s.indexOf("[");if(a===-1)return l.err(new g(k.Fen));i=ot(s.slice(0,a)),n=Et(s.slice(a+1,-1))}else{const a=Yt(s,"/",7);a===-1?i=ot(s):(i=ot(s.slice(0,a)),n=Et(s.slice(a+1)))}let o;const h=t.shift();if(!c(h)||h==="w")o="white";else if(h==="b")o="black";else return l.err(new g(k.Turn));return i.chain(a=>{const u=t.shift(),d=c(u)?Jt(a,u):l.ok(r.empty()),M=t.shift();let x;if(c(M)&&M!=="-"&&(x=U(M),!c(x)))return l.err(new g(k.EpSquare));let p=t.shift(),y;c(p)&&p.includes("+")&&(y=Ct(p),p=t.shift());const G=c(p)?L(p):0;if(!c(G))return l.err(new g(k.Halfmoves));const F=t.shift(),j=c(F)?L(F):1;if(!c(j))return l.err(new g(k.Fullmoves));const Pt=t.shift();let ct=l.ok(void 0);if(c(Pt)){if(c(y))return l.err(new g(k.RemainingChecks));ct=Ct(Pt)}else c(y)&&(ct=y);return t.length>0?l.err(new g(k.Fen)):n.chain(fe=>d.chain(ue=>ct.map(de=>({board:a,pockets:fe,turn:o,castlingRights:ue,remainingChecks:de,epSquare:x,halfmoves:G,fullmoves:Math.max(1,j)}))))})},Xt=e=>{let t=lt(e.role);return e.color==="white"&&(t=t.toUpperCase()),e.promoted&&(t+="~"),t},Zt=e=>{let t="",s=0;for(let i=7;i>=0;i--)for(let n=0;n<8;n++){const o=n+i*8,h=e.get(o);h?(s>0&&(t+=s,s=0),t+=Xt(h)):s++,n===7&&(s>0&&(t+=s,s=0),i!==0&&(t+="/"))}return t},_t=e=>b.map(t=>lt(t).repeat(e[t])).join(""),qt=e=>_t(e.white).toUpperCase()+_t(e.black),te=(e,t)=>{let s="";for(const i of m){const n=r.backrank(i);let o=e.kingOf(i);c(o)&&!n.has(o)&&(o=void 0);const h=e.pieces(i,"rook").intersect(n);for(const a of t.intersect(n).reversed())if(a===h.first()&&c(o)&&a<o)s+=i==="white"?"Q":"q";else if(a===h.last()&&c(o)&&o<a)s+=i==="white"?"K":"k";else{const u=R[O(a)];s+=i==="white"?u.toUpperCase():u}}return s||"-"},ee=e=>`${e.white}+${e.black}`,se=(e,t)=>[Zt(e.board)+(e.pockets?`[${qt(e.pockets)}]`:""),e.turn[0],te(e.board,e.castlingRights),c(e.epSquare)?Mt(e.epSquare):"-",...e.remainingChecks?[ee(e.remainingChecks)]:[],Math.max(0,Math.min(e.halfmoves,9999)),Math.max(1,Math.min(e.fullmoves,9999))].join(" ");function ie(e,t,s){let i=gt.fromSetup(Rt(e).unwrap()).unwrap();s||(s=i.turn);let n=Kt(i.board.king.intersect(i.board[s]).singleSquare()),o=n[4];return n.every((a,u)=>{var x;let d=t.slice(u*2,u*2+2);if(d==="Oo")return a===void 0;if(a===void 0)return!1;let M=d[0].toLowerCase()===d[0]?w(s):s;if(d[1]==="o")return((x=i.board.get(a))==null?void 0:x.color)===M;if(d[1]==="n"){let p=[];d[0].toLowerCase()==="f"?p=b.slice(0):d[0].toLowerCase()==="r"?p=["rook"]:d[0].toLowerCase()==="q"?p=["queen"]:d[0].toLowerCase()==="n"?p=["knight"]:d[0].toLowerCase()==="b"?p=["bishop"]:d[0].toLowerCase()==="k"?p=["king"]:d[0].toLowerCase()==="p"&&(p=["pawn"]);let y=i.clone();return y.turn=M,y.board.take(o),p.find(F=>{for(let j of y.board[F])if(y.dests(j).has(a))return!0})!==void 0}return!0})}let K=[],ht,At=[],H=!0;const ne=async()=>{K=await oe(),H=!0,Ot(),at()},re=e=>{At=e,H=!0,at()},oe=()=>fetch("/data/tenk_puzzle.csv").then(e=>e.text()).then(he),he=e=>{let t=e.trim().split(`
`);return t.map((s,i)=>{xt(i,t.length);let[n,o,h,a,u,d,M,x]=s.split(","),p=gt.fromSetup(Rt(o).unwrap()).unwrap();h.split(" ").forEach(F=>{p.play(Nt(F))}),o=se(p.toSetup());let y=[],G=[];return{id:n,fen:o,moves:h,tags:x.split(" "),has_tags:y,has_pattern:G}})},ae=e=>[...e.tags,...e.has_tags],ce=e=>t=>{let s=ae(t),[i,n]=e.split("_!_").map(h=>h.trim()),o=i===""?[]:i.split(" ");if(n){let h=n.split(" ");if(s.find(a=>h.includes(a)))return!1}return o.every(h=>s.includes(h))};function xt(e,t){postMessage({t:"progress",d:[e,t]})}function Ot(){postMessage({t:"progress"})}const le=e=>{ht=e,at()},at=()=>{H&&(K.forEach((s,i)=>{xt(i,K.length);let n=s.has_pattern;s.has_tags=[],s.has_pattern=[],At.forEach(o=>{(n.includes(o.pattern)||ie(s.fen,o.pattern))&&(s.has_tags.push(o.name),s.has_pattern.push(o.pattern),s.has_tags.includes("has_tag")||s.has_tags.push("has_tag"),s.has_tags.length===2?s.has_tags.includes("single_tag")||s.has_tags.push("single_tag"):s.has_tags=s.has_tags.filter(h=>h!=="single_tag"))})}),H=!1);let e=K,t=ht?K.filter(ce(ht)):K;postMessage({t:"puzzles",d:{all:e,filtered:t}}),Ot()};onmessage=e=>{switch(e.data.t){case"filter":le(e.data.d);break;case"patterns":re(e.data.d);break}},ne()})();
